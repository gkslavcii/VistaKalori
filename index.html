<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#e85d3a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CalorieMate">
<meta name="description" content="G√ºnl√ºk kalori ve beslenme takip uygulamasƒ±">
<link rel="manifest" id="manifestLink">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23e85d3a' width='100' height='100' rx='20'/><text x='50' y='68' text-anchor='middle' font-size='55'>üçΩ</text></svg>">
<title>CalorieMate</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #faf8f4;
  --card: #ffffff;
  --text: #1a1a1a;
  --text2: #6b6b6b;
  --accent: #e85d3a;
  --accent2: #ff7a54;
  --green: #2daa6e;
  --green-light: #e8f7ef;
  --blue: #3a8fe8;
  --blue-light: #e8f0fb;
  --orange: #e8a23a;
  --orange-light: #fdf3e0;
  --red: #e84d4d;
  --red-light: #fde8e8;
  --purple: #8b5cf6;
  --purple-light: #f0ebfe;
  --border: #eae6df;
  --shadow: 0 2px 16px rgba(0,0,0,0.06);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.1);
  --radius: 16px;
  --radius-sm: 10px;
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  max-width: 430px;
  margin: 0 auto;
  min-height: 100vh;
  min-height: 100dvh;
  position: relative;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ====== HEADER ====== */
.header {
  padding: 16px 20px 18px;
  background: linear-gradient(145deg, var(--accent), #c9421e);
  color: white;
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '';
  position: absolute;
  top: -60px; right: -30px;
  width: 160px; height: 160px;
  border-radius: 50%;
  background: rgba(255,255,255,0.06);
}

.header::after {
  content: '';
  position: absolute;
  bottom: -40px; left: -20px;
  width: 100px; height: 100px;
  border-radius: 50%;
  background: rgba(255,255,255,0.04);
}

.header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 14px;
  position: relative;
  z-index: 2;
}

.header h1 {
  font-family: 'Playfair Display', serif;
  font-size: 1.45rem;
  font-weight: 800;
  letter-spacing: -0.5px;
}

.header .date {
  font-size: 0.78rem;
  opacity: 0.8;
  font-weight: 500;
  margin-top: 1px;
}

.header-actions { display: flex; gap: 8px; }

.header .icon-btn {
  background: rgba(255,255,255,0.14);
  border: none;
  color: white;
  width: 36px; height: 36px;
  border-radius: 10px;
  font-size: 1.05rem;
  cursor: pointer;
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
}

.header .icon-btn:active { background: rgba(255,255,255,0.25); }

/* Calorie Ring */
.calorie-ring-section {
  display: flex;
  align-items: center;
  gap: 18px;
  position: relative;
  z-index: 2;
}

.ring-container {
  position: relative;
  width: 105px; height: 105px;
  flex-shrink: 0;
}

.ring-container svg { transform: rotate(-90deg); }

.ring-text {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

.ring-text .cal-num {
  font-family: 'Playfair Display', serif;
  font-size: 1.5rem;
  font-weight: 800;
  display: block;
  line-height: 1;
}

.ring-text .cal-label {
  font-size: 0.6rem;
  opacity: 0.75;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-top: 2px;
}

.macro-summary {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 9px;
}

.macro-row {
  display: flex;
  align-items: center;
  gap: 7px;
}

.macro-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  flex-shrink: 0;
}

.macro-row .macro-name {
  font-size: 0.74rem;
  opacity: 0.85;
  width: 50px;
}

.macro-bar-bg {
  flex: 1;
  height: 5px;
  background: rgba(255,255,255,0.13);
  border-radius: 3px;
  overflow: hidden;
}

.macro-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.6s cubic-bezier(0.25,1,0.5,1);
}

.macro-row .macro-val {
  font-size: 0.7rem;
  font-weight: 700;
  min-width: 36px;
  text-align: right;
  opacity: 0.9;
}

/* ====== DATE NAVIGATION ====== */
.date-nav {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
  padding: 12px 16px;
  background: var(--card);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 20;
}

.date-nav button {
  background: var(--bg);
  border: 1px solid var(--border);
  width: 32px; height: 32px;
  border-radius: 8px;
  font-size: 0.9rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
}

.date-nav button:active { background: var(--border); }

.date-nav .current-date {
  font-weight: 700;
  font-size: 0.88rem;
  min-width: 140px;
  text-align: center;
}

.date-nav .today-btn {
  font-family: 'DM Sans', sans-serif;
  font-size: 0.72rem;
  font-weight: 700;
  color: var(--accent);
  background: none;
  border: 1px solid var(--accent);
  border-radius: 6px;
  padding: 4px 10px;
  cursor: pointer;
  width: auto;
  height: auto;
  display: none;
}

.date-nav .today-btn.show { display: inline-flex; }

/* ====== CONTENT ====== */
.content { padding: 14px 16px 100px; }

/* ====== MEAL SECTIONS ====== */
.meal-section {
  margin-bottom: 14px;
  animation: fadeUp 0.35s ease both;
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.meal-section:nth-child(2) { animation-delay: 0.04s; }
.meal-section:nth-child(3) { animation-delay: 0.08s; }
.meal-section:nth-child(4) { animation-delay: 0.12s; }

.meal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.meal-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 700;
  font-size: 0.95rem;
}

.meal-title .meal-icon {
  width: 30px; height: 30px;
  border-radius: 9px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
}

.meal-kcal {
  font-size: 0.8rem;
  color: var(--text2);
  font-weight: 600;
}

.meal-card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  overflow: hidden;
  border: 1px solid var(--border);
}

.food-item {
  display: flex;
  align-items: center;
  padding: 11px 12px;
  gap: 10px;
  border-bottom: 1px solid #f5f2ed;
  transition: background 0.15s;
}

.food-item:last-of-type { border-bottom: none; }

.food-emoji {
  width: 38px; height: 38px;
  border-radius: 10px;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  flex-shrink: 0;
}

.food-info { flex: 1; min-width: 0; }

.food-name {
  font-weight: 600;
  font-size: 0.84rem;
  margin-bottom: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.food-macros {
  font-size: 0.68rem;
  color: var(--text2);
  display: flex;
  gap: 5px;
}

.food-cal {
  font-weight: 700;
  font-size: 0.88rem;
  color: var(--accent);
  flex-shrink: 0;
  margin-right: 4px;
}

.food-delete {
  background: none;
  border: none;
  color: #ccc;
  font-size: 1rem;
  cursor: pointer;
  padding: 6px;
  border-radius: 8px;
  transition: all 0.2s;
  flex-shrink: 0;
}

.food-delete:active { color: var(--red); background: var(--red-light); }

.add-food-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
  padding: 11px;
  color: var(--accent);
  font-weight: 600;
  font-size: 0.82rem;
  cursor: pointer;
  border-top: 1px dashed var(--border);
  transition: background 0.15s;
}

.add-food-btn:active { background: #fdf8f4; }

.empty-meal {
  padding: 20px;
  text-align: center;
  color: var(--text2);
  font-size: 0.82rem;
}

/* ====== STATS ====== */
.stat-card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  padding: 16px;
  margin-bottom: 12px;
  animation: fadeUp 0.35s ease both;
}

.stat-card h3 {
  font-size: 0.86rem;
  font-weight: 700;
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 7px;
}

.week-chart {
  display: flex;
  align-items: flex-end;
  gap: 5px;
  height: 110px;
  padding-top: 8px;
}

.week-bar {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  height: 100%;
  justify-content: flex-end;
}

.week-bar .bar {
  width: 100%;
  border-radius: 5px 5px 3px 3px;
  min-height: 3px;
  transition: height 0.5s ease;
}

.week-bar .bar.over { background: linear-gradient(to top, var(--red), #ff7070); }
.week-bar .bar.under { background: linear-gradient(to top, var(--green), #5dd9a0); }
.week-bar .bar.today { background: linear-gradient(to top, var(--accent), var(--accent2)); }
.week-bar .bar.empty { background: #eee; min-height: 3px; }

.week-bar .day-label { font-size: 0.65rem; color: var(--text2); font-weight: 600; }
.week-bar .cal-label { font-size: 0.6rem; font-weight: 700; color: var(--text); }

.target-line {
  width: 100%;
  border-top: 2px dashed rgba(0,0,0,0.1);
  position: relative;
  margin-bottom: 8px;
}

.target-line span {
  position: absolute;
  right: 0;
  top: -15px;
  font-size: 0.62rem;
  color: var(--text2);
  font-weight: 600;
}

.macro-detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 8px;
}

.macro-detail-item {
  text-align: center;
  padding: 10px 6px;
  border-radius: var(--radius-sm);
}

.macro-detail-item .macro-circle {
  width: 48px; height: 48px;
  border-radius: 50%;
  margin: 0 auto 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 0.82rem;
}

.macro-detail-item .md-name { font-size: 0.68rem; color: var(--text2); font-weight: 600; }
.macro-detail-item .md-val { font-size: 0.78rem; font-weight: 700; margin-top: 2px; }

/* ====== PROFILE ====== */
.profile-card {
  background: var(--card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  padding: 18px;
  margin-bottom: 12px;
  animation: fadeUp 0.35s ease both;
}

.profile-card h3 { font-size: 0.9rem; font-weight: 700; margin-bottom: 14px; }

.profile-field {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid #f5f2ed;
}

.profile-field:last-of-type { border-bottom: none; }

.profile-field label { font-size: 0.82rem; color: var(--text2); font-weight: 500; }

.profile-field input, .profile-field select {
  font-family: 'DM Sans', sans-serif;
  font-size: 0.85rem;
  font-weight: 600;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  padding: 7px 10px;
  width: 135px;
  text-align: right;
  background: var(--bg);
  color: var(--text);
  outline: none;
  transition: border 0.2s;
}

.profile-field input:focus, .profile-field select:focus { border-color: var(--accent); }

.calc-btn {
  width: 100%;
  padding: 13px;
  background: linear-gradient(135deg, var(--accent), #c9421e);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.9rem;
  font-weight: 700;
  cursor: pointer;
  margin-top: 6px;
  transition: transform 0.15s;
  box-shadow: 0 4px 15px rgba(232, 93, 58, 0.25);
}

.calc-btn:active { transform: scale(0.98); }

.calorie-result {
  text-align: center;
  padding: 14px;
  background: linear-gradient(135deg, #fff8f4, #fdf0ea);
  border-radius: var(--radius-sm);
  margin-top: 12px;
  display: none;
}

.calorie-result.show { display: block; animation: fadeUp 0.3s ease; }

.calorie-result .big-num {
  font-family: 'Playfair Display', serif;
  font-size: 2.2rem;
  font-weight: 800;
  color: var(--accent);
}

.calorie-result .result-label { font-size: 0.76rem; color: var(--text2); margin-top: 2px; }

/* ====== MODAL ====== */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.45);
  z-index: 100;
  display: none;
  align-items: flex-end;
  justify-content: center;
  backdrop-filter: blur(3px);
}

.modal-overlay.show { display: flex; }

.modal {
  background: var(--card);
  border-radius: 22px 22px 0 0;
  width: 100%;
  max-width: 430px;
  max-height: 82vh;
  overflow-y: auto;
  padding: 16px 18px 24px;
  animation: slideUp 0.3s cubic-bezier(0.25,1,0.5,1);
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.modal-handle {
  width: 36px; height: 4px;
  background: #ddd;
  border-radius: 2px;
  margin: 0 auto 14px;
}

.modal h2 { font-size: 1.05rem; font-weight: 700; margin-bottom: 14px; }

.search-box {
  width: 100%;
  padding: 11px 14px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.88rem;
  outline: none;
  background: var(--bg);
  margin-bottom: 10px;
  transition: border 0.2s;
}

.search-box:focus { border-color: var(--accent); }

/* Category pills */
.cat-pills {
  display: flex;
  gap: 6px;
  margin-bottom: 10px;
  overflow-x: auto;
  padding-bottom: 4px;
}

.cat-pill {
  font-family: 'DM Sans', sans-serif;
  font-size: 0.74rem;
  font-weight: 600;
  padding: 6px 12px;
  border-radius: 20px;
  border: 1.5px solid var(--border);
  background: white;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.15s;
  color: var(--text2);
}

.cat-pill.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}

.food-db-list { max-height: 220px; overflow-y: auto; }

.food-db-item {
  display: flex;
  align-items: center;
  padding: 9px 10px;
  gap: 9px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: background 0.15s;
  margin-bottom: 1px;
}

.food-db-item:active { background: #faf6f0; }

.food-db-item .fdb-emoji { font-size: 1.2rem; }
.food-db-item .fdb-info { flex: 1; }
.food-db-item .fdb-name { font-weight: 600; font-size: 0.82rem; }
.food-db-item .fdb-detail { font-size: 0.68rem; color: var(--text2); }
.food-db-item .fdb-cal { font-weight: 700; font-size: 0.82rem; color: var(--accent); }

.divider {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 14px 0;
  color: var(--text2);
  font-size: 0.76rem;
  font-weight: 600;
}

.divider::before, .divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

.custom-form { display: flex; flex-direction: column; gap: 8px; }

.custom-form .form-row { display: flex; gap: 7px; }

.custom-form input {
  font-family: 'DM Sans', sans-serif;
  font-size: 0.82rem;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  padding: 9px 10px;
  outline: none;
  background: var(--bg);
  color: var(--text);
  flex: 1;
  transition: border 0.2s;
  min-width: 0;
}

.custom-form input:focus { border-color: var(--accent); }

.custom-form .submit-btn {
  padding: 11px;
  background: var(--green);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-family: 'DM Sans', sans-serif;
  font-weight: 700;
  font-size: 0.85rem;
  cursor: pointer;
  transition: transform 0.15s;
}

.custom-form .submit-btn:active { transform: scale(0.98); }

.modal-cancel {
  background: none;
  border: none;
  color: var(--text2);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.82rem;
  font-weight: 600;
  cursor: pointer;
  padding: 10px;
  width: 100%;
  margin-top: 8px;
}

/* ====== BOTTOM NAV ====== */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 430px;
  background: var(--card);
  border-top: 1px solid var(--border);
  display: flex;
  padding: 6px 0 max(10px, env(safe-area-inset-bottom));
  z-index: 50;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.04);
}

.nav-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  padding: 6px;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
  background: none;
  font-family: 'DM Sans', sans-serif;
}

.nav-item .nav-icon { font-size: 1.25rem; line-height: 1; transition: transform 0.2s; }
.nav-item .nav-label { font-size: 0.62rem; font-weight: 600; color: var(--text2); transition: color 0.2s; }
.nav-item.active .nav-label { color: var(--accent); }
.nav-item.active .nav-icon { transform: scale(1.15); }

/* ====== TOAST ====== */
.toast {
  position: fixed;
  top: 16px;
  left: 50%;
  transform: translateX(-50%) translateY(-80px);
  background: #1a1a1a;
  color: white;
  padding: 10px 18px;
  border-radius: 10px;
  font-size: 0.82rem;
  font-weight: 600;
  z-index: 200;
  transition: transform 0.3s cubic-bezier(0.25,1,0.5,1);
  box-shadow: var(--shadow-lg);
  max-width: 85%;
  text-align: center;
  white-space: nowrap;
}

.toast.show { transform: translateX(-50%) translateY(0); }

/* ====== PWA INSTALL BANNER ====== */
.install-banner {
  display: none;
  background: linear-gradient(135deg, #1a1a2e, #2a2a4e);
  color: white;
  padding: 14px 16px;
  margin: 0 16px 12px;
  border-radius: var(--radius);
  align-items: center;
  gap: 12px;
  animation: fadeUp 0.4s ease;
}

.install-banner.show { display: flex; }

.install-banner .ib-text { flex: 1; }
.install-banner .ib-title { font-weight: 700; font-size: 0.85rem; margin-bottom: 2px; }
.install-banner .ib-desc { font-size: 0.72rem; opacity: 0.75; }

.install-banner .ib-btn {
  font-family: 'DM Sans', sans-serif;
  background: var(--accent);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: 700;
  font-size: 0.8rem;
  cursor: pointer;
  flex-shrink: 0;
}

.install-banner .ib-close {
  background: none;
  border: none;
  color: rgba(255,255,255,0.5);
  font-size: 1.1rem;
  cursor: pointer;
  padding: 4px;
}

/* ====== PAGES ====== */
.page { display: none; }
.page.active { display: block; }

/* ====== PORTION MODAL ====== */
.portion-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 10px 0;
  padding: 10px 12px;
  background: var(--bg);
  border-radius: var(--radius-sm);
}

.portion-row label { font-size: 0.82rem; font-weight: 600; color: var(--text2); }

.portion-row input {
  font-family: 'DM Sans', sans-serif;
  font-size: 0.9rem;
  font-weight: 700;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  padding: 7px 10px;
  width: 80px;
  text-align: center;
  background: white;
  color: var(--text);
  outline: none;
}

.portion-row input:focus { border-color: var(--accent); }

.portion-row .unit { font-size: 0.82rem; font-weight: 600; }

.portion-preview {
  display: flex;
  justify-content: space-around;
  padding: 8px 0;
  font-size: 0.78rem;
  color: var(--text2);
  font-weight: 600;
}

.portion-preview span { display: flex; flex-direction: column; align-items: center; gap: 2px; }
.portion-preview .pv-val { font-weight: 800; color: var(--text); font-size: 0.88rem; }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-top">
    <div>
      <h1>üçΩÔ∏è CalorieMate</h1>
      <div class="date" id="todayDate"></div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="switchTab('profil')" title="Profil">‚öôÔ∏è</button>
    </div>
  </div>
  <div class="calorie-ring-section">
    <div class="ring-container">
      <svg width="105" height="105" viewBox="0 0 105 105">
        <circle cx="52.5" cy="52.5" r="44" fill="none" stroke="rgba(255,255,255,0.12)" stroke-width="9"/>
        <circle cx="52.5" cy="52.5" r="44" fill="none" stroke="white" stroke-width="9"
          stroke-dasharray="276.5" stroke-dashoffset="276.5" stroke-linecap="round" id="calRing"/>
      </svg>
      <div class="ring-text">
        <span class="cal-num" id="calRemain">2200</span>
        <span class="cal-label">kalan</span>
      </div>
    </div>
    <div class="macro-summary">
      <div class="macro-row">
        <div class="macro-dot" style="background:#ff7a7a"></div>
        <span class="macro-name">Protein</span>
        <div class="macro-bar-bg"><div class="macro-bar-fill" id="protBar" style="width:0%;background:#ff7a7a"></div></div>
        <span class="macro-val" id="protVal">0g</span>
      </div>
      <div class="macro-row">
        <div class="macro-dot" style="background:#ffcc55"></div>
        <span class="macro-name">Karb</span>
        <div class="macro-bar-bg"><div class="macro-bar-fill" id="carbBar" style="width:0%;background:#ffcc55"></div></div>
        <span class="macro-val" id="carbVal">0g</span>
      </div>
      <div class="macro-row">
        <div class="macro-dot" style="background:#77bbff"></div>
        <span class="macro-name">Yaƒü</span>
        <div class="macro-bar-bg"><div class="macro-bar-fill" id="fatBar" style="width:0%;background:#77bbff"></div></div>
        <span class="macro-val" id="fatVal">0g</span>
      </div>
    </div>
  </div>
</div>

<!-- Date Nav -->
<div class="date-nav">
  <button onclick="changeDate(-1)">‚óÄ</button>
  <span class="current-date" id="navDate">Bug√ºn</span>
  <button onclick="changeDate(1)">‚ñ∂</button>
  <button class="today-btn" id="todayBtn" onclick="goToday()">Bug√ºn</button>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Pages -->
<div class="page active" id="page-gunluk">
  <div class="content">
    <div class="install-banner" id="installBanner">
      <div class="ib-text">
        <div class="ib-title">üì± Telefona Kur</div>
        <div class="ib-desc">Ana ekrana ekle, uygulama gibi kullan</div>
      </div>
      <button class="ib-btn" id="installBtn" onclick="installPWA()">Kur</button>
      <button class="ib-close" onclick="dismissInstall()">‚úï</button>
    </div>
    <div id="mealsContainer"></div>
  </div>
</div>

<div class="page" id="page-istatistik">
  <div class="content" id="statsContainer"></div>
</div>

<div class="page" id="page-profil">
  <div class="content">
    <div class="profile-card">
      <h3>üë§ Ki≈üisel Bilgiler</h3>
      <div class="profile-field">
        <label>Cinsiyet</label>
        <select id="pGender" onchange="saveProfile()">
          <option value="male">Erkek</option>
          <option value="female">Kadƒ±n</option>
        </select>
      </div>
      <div class="profile-field">
        <label>Ya≈ü</label>
        <input type="number" id="pAge" value="25" min="10" max="100" onchange="saveProfile()">
      </div>
      <div class="profile-field">
        <label>Boy (cm)</label>
        <input type="number" id="pHeight" value="175" min="100" max="250" onchange="saveProfile()">
      </div>
      <div class="profile-field">
        <label>Kilo (kg)</label>
        <input type="number" id="pWeight" value="75" min="30" max="300" onchange="saveProfile()">
      </div>
      <div class="profile-field">
        <label>Aktivite</label>
        <select id="pActivity" onchange="saveProfile()">
          <option value="1.2">Hareketsiz</option>
          <option value="1.375" selected>Az hareketli</option>
          <option value="1.55">Orta aktif</option>
          <option value="1.725">√áok aktif</option>
          <option value="1.9">Ekstra aktif</option>
        </select>
      </div>
      <div class="profile-field">
        <label>Hedef</label>
        <select id="pGoal" onchange="saveProfile()">
          <option value="-500">Kilo vermek</option>
          <option value="0" selected>Korumak</option>
          <option value="300">Kilo almak</option>
        </select>
      </div>
      <button class="calc-btn" onclick="calculateTDEE()">üî¢ Kalori ƒ∞htiyacƒ±nƒ± Hesapla</button>
      <div class="calorie-result" id="calResult">
        <div class="big-num" id="tdeeNum">2200</div>
        <div class="result-label">G√ºnl√ºk Kalori Hedefiniz (kcal)</div>
      </div>
    </div>

    <div class="profile-card" style="animation-delay:0.05s">
      <h3>üì¶ Veri Y√∂netimi</h3>
      <div class="profile-field">
        <label>T√ºm verileri sƒ±fƒ±rla</label>
        <button style="font-family:'DM Sans';font-size:0.82rem;font-weight:600;padding:7px 14px;border:1.5px solid var(--red);color:var(--red);background:white;border-radius:8px;cursor:pointer" onclick="resetAllData()">üóëÔ∏è Sƒ±fƒ±rla</button>
      </div>
    </div>

    <div class="profile-card" style="animation-delay:0.1s">
      <h3>‚ÑπÔ∏è Hakkƒ±nda</h3>
      <p style="font-size:0.78rem;color:var(--text2);line-height:1.6">
        CalorieMate v1.0 ‚Äî Ki≈üisel beslenme takip uygulamanƒ±z.<br>
        √ñƒü√ºn bazlƒ± kalori ve makro takibi yapƒ±n, kendi yemeklerinizi ekleyin veya hazƒ±r veritabanƒ±ndan se√ßin.<br><br>
        üîú Gelecek √∂zellikler: Su takibi, tarif √∂nerileri, widget desteƒüi
      </p>
    </div>
  </div>
</div>

<!-- Bottom Nav -->
<div class="bottom-nav">
  <button class="nav-item active" onclick="switchTab('gunluk')" id="nav-gunluk">
    <span class="nav-icon">üçΩÔ∏è</span>
    <span class="nav-label">G√ºnl√ºk</span>
  </button>
  <button class="nav-item" onclick="switchTab('istatistik')" id="nav-istatistik">
    <span class="nav-icon">üìä</span>
    <span class="nav-label">ƒ∞statistik</span>
  </button>
  <button class="nav-item" onclick="switchTab('profil')" id="nav-profil">
    <span class="nav-icon">üë§</span>
    <span class="nav-label">Profil</span>
  </button>
</div>

<!-- Add Food Modal -->
<div class="modal-overlay" id="addFoodModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 id="modalTitle">üçΩÔ∏è Yemek Ekle</h2>
    
    <input type="text" class="search-box" placeholder="üîç Yemek ara..." id="foodSearch" oninput="filterFoods()">
    
    <div class="cat-pills" id="catPills">
      <button class="cat-pill active" onclick="filterCat('all')">T√ºm√º</button>
      <button class="cat-pill" onclick="filterCat('kahvalti')">üåÖ Kahvaltƒ±</button>
      <button class="cat-pill" onclick="filterCat('ana')">üçñ Ana Yemek</button>
      <button class="cat-pill" onclick="filterCat('atistirmalik')">üçø Atƒ±≈ütƒ±rmalƒ±k</button>
      <button class="cat-pill" onclick="filterCat('icecek')">ü•§ ƒ∞√ßecek</button>
    </div>
    
    <div class="food-db-list" id="foodDbList"></div>
    
    <div class="divider">veya kendin ekle</div>
    
    <div class="custom-form">
      <input type="text" placeholder="Yemek adƒ±" id="customName">
      <div class="form-row">
        <input type="number" placeholder="Kalori (kcal)" id="customCal">
        <input type="number" placeholder="Porsiyon (g)" id="customPortion" value="100">
      </div>
      <div class="form-row">
        <input type="number" placeholder="Protein (g)" id="customProt">
        <input type="number" placeholder="Karb (g)" id="customCarb">
        <input type="number" placeholder="Yaƒü (g)" id="customFat">
      </div>
      <button class="submit-btn" onclick="addCustomFood()">‚úÖ Ekle</button>
    </div>
    
    <button class="modal-cancel" onclick="closeModal()">ƒ∞ptal</button>
  </div>
</div>

<!-- Portion Modal -->
<div class="modal-overlay" id="portionModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h2 id="portionTitle">Porsiyon Ayarla</h2>
    
    <div style="display:flex;align-items:center;gap:12px;padding:10px 0">
      <span style="font-size:2rem" id="portionEmoji"></span>
      <div>
        <div style="font-weight:700;font-size:0.92rem" id="portionFoodName"></div>
        <div style="font-size:0.75rem;color:var(--text2)" id="portionFoodBase"></div>
      </div>
    </div>

    <div class="portion-row">
      <label>Miktar</label>
      <input type="number" id="portionInput" value="100" min="1" oninput="updatePortionPreview()">
      <span class="unit">gram</span>
    </div>

    <div class="portion-preview" id="portionPreview"></div>

    <button class="submit-btn" style="width:100%;margin-top:8px;padding:12px;background:var(--green);color:white;border:none;border-radius:10px;font-family:'DM Sans';font-weight:700;font-size:0.88rem;cursor:pointer" onclick="confirmPortion()">‚úÖ Ekle</button>
    <button class="modal-cancel" onclick="closePortionModal()">ƒ∞ptal</button>
  </div>
</div>

<script>
// ============ FOOD DATABASE ============
const FOOD_DB = [
  { name:'Yumurta (ha≈ülanmƒ±≈ü)', emoji:'ü•ö', cal:155, prot:13, carb:1, fat:11, portion:100, cat:'kahvalti' },
  { name:'Beyaz Peynir', emoji:'üßÄ', cal:264, prot:17, carb:1, fat:21, portion:100, cat:'kahvalti' },
  { name:'Ka≈üar Peyniri', emoji:'üßÄ', cal:313, prot:25, carb:1, fat:23, portion:100, cat:'kahvalti' },
  { name:'Zeytin (ye≈üil)', emoji:'ü´í', cal:145, prot:1, carb:4, fat:15, portion:100, cat:'kahvalti' },
  { name:'Zeytin (siyah)', emoji:'ü´í', cal:115, prot:1, carb:6, fat:11, portion:100, cat:'kahvalti' },
  { name:'Domates', emoji:'üçÖ', cal:18, prot:1, carb:4, fat:0, portion:100, cat:'kahvalti' },
  { name:'Salatalƒ±k', emoji:'ü•í', cal:15, prot:1, carb:4, fat:0, portion:100, cat:'kahvalti' },
  { name:'Tam Buƒüday Ekmeƒüi', emoji:'üçû', cal:247, prot:13, carb:41, fat:3, portion:100, cat:'kahvalti' },
  { name:'Beyaz Ekmek', emoji:'üçû', cal:265, prot:9, carb:49, fat:3, portion:100, cat:'kahvalti' },
  { name:'Bal', emoji:'üçØ', cal:304, prot:0, carb:82, fat:0, portion:100, cat:'kahvalti' },
  { name:'Tereyaƒüƒ±', emoji:'üßà', cal:717, prot:1, carb:0, fat:81, portion:100, cat:'kahvalti' },
  { name:'Menemen', emoji:'üç≥', cal:70, prot:4, carb:3, fat:5, portion:100, cat:'kahvalti' },
  { name:'Simit', emoji:'ü•Ø', cal:233, prot:8, carb:42, fat:4, portion:100, cat:'kahvalti' },
  { name:'Poƒüa√ßa', emoji:'ü•ê', cal:310, prot:6, carb:35, fat:16, portion:100, cat:'kahvalti' },
  { name:'Sucuklu Yumurta', emoji:'üç≥', cal:200, prot:14, carb:1, fat:16, portion:100, cat:'kahvalti' },
  
  { name:'Tavuk G√∂ƒüs√º (ƒ±zgara)', emoji:'üçó', cal:165, prot:31, carb:0, fat:4, portion:100, cat:'ana' },
  { name:'Tavuk But (fƒ±rƒ±nda)', emoji:'üçó', cal:209, prot:26, carb:0, fat:11, portion:100, cat:'ana' },
  { name:'Kƒ±ymalƒ± Makarna', emoji:'üçù', cal:160, prot:8, carb:18, fat:6, portion:100, cat:'ana' },
  { name:'Kuru Fasulye', emoji:'ü´ò', cal:70, prot:5, carb:11, fat:1, portion:100, cat:'ana' },
  { name:'Mercimek √áorbasƒ±', emoji:'üç≤', cal:48, prot:3, carb:7, fat:1, portion:100, cat:'ana' },
  { name:'Pilav', emoji:'üçö', cal:130, prot:3, carb:28, fat:0, portion:100, cat:'ana' },
  { name:'Bulgur Pilavƒ±', emoji:'üçö', cal:83, prot:3, carb:19, fat:0, portion:100, cat:'ana' },
  { name:'K√∂fte', emoji:'üßÜ', cal:250, prot:17, carb:10, fat:16, portion:100, cat:'ana' },
  { name:'Lahmacun', emoji:'ü´ì', cal:180, prot:8, carb:21, fat:7, portion:100, cat:'ana' },
  { name:'D√∂ner (tavuk)', emoji:'ü•ô', cal:120, prot:13, carb:3, fat:6, portion:100, cat:'ana' },
  { name:'D√∂ner (et)', emoji:'ü•ô', cal:150, prot:14, carb:4, fat:9, portion:100, cat:'ana' },
  { name:'Pide (kƒ±ymalƒ±)', emoji:'ü´ì', cal:145, prot:7, carb:18, fat:5, portion:100, cat:'ana' },
  { name:'Balƒ±k (ƒ±zgara)', emoji:'üêü', cal:87, prot:17, carb:0, fat:2, portion:100, cat:'ana' },
  { name:'Karƒ±≈üƒ±k Salata', emoji:'ü•ó', cal:40, prot:2, carb:5, fat:2, portion:100, cat:'ana' },
  { name:'Etli Nohut', emoji:'ü´ò', cal:74, prot:6, carb:8, fat:2, portion:100, cat:'ana' },
  { name:'ƒ∞skender', emoji:'ü•ô', cal:155, prot:11, carb:8, fat:9, portion:100, cat:'ana' },
  { name:'Mantƒ±', emoji:'ü•ü', cal:150, prot:7, carb:18, fat:5, portion:100, cat:'ana' },
  { name:'Karnƒ±yarƒ±k', emoji:'üçÜ', cal:95, prot:5, carb:8, fat:5, portion:100, cat:'ana' },
  { name:'ƒ∞mam Bayƒ±ldƒ±', emoji:'üçÜ', cal:70, prot:2, carb:8, fat:4, portion:100, cat:'ana' },
  
  { name:'Muz', emoji:'üçå', cal:89, prot:1, carb:23, fat:0, portion:100, cat:'atistirmalik' },
  { name:'Elma', emoji:'üçé', cal:52, prot:0, carb:14, fat:0, portion:100, cat:'atistirmalik' },
  { name:'Portakal', emoji:'üçä', cal:47, prot:1, carb:12, fat:0, portion:100, cat:'atistirmalik' },
  { name:'√úz√ºm', emoji:'üçá', cal:69, prot:1, carb:18, fat:0, portion:100, cat:'atistirmalik' },
  { name:'√áilek', emoji:'üçì', cal:32, prot:1, carb:8, fat:0, portion:100, cat:'atistirmalik' },
  { name:'Badem', emoji:'ü•ú', cal:579, prot:21, carb:22, fat:50, portion:100, cat:'atistirmalik' },
  { name:'Ceviz', emoji:'ü•ú', cal:654, prot:15, carb:14, fat:65, portion:100, cat:'atistirmalik' },
  { name:'Yoƒüurt', emoji:'ü•õ', cal:60, prot:5, carb:5, fat:2, portion:100, cat:'atistirmalik' },
  { name:'√áikolata (bitter)', emoji:'üç´', cal:546, prot:5, carb:60, fat:31, portion:100, cat:'atistirmalik' },
  { name:'Protein Bar', emoji:'üç´', cal:333, prot:33, carb:37, fat:12, portion:100, cat:'atistirmalik' },
  { name:'Kuru Kayƒ±sƒ±', emoji:'üü†', cal:241, prot:3, carb:63, fat:1, portion:100, cat:'atistirmalik' },
  { name:'Hurma', emoji:'üü§', cal:277, prot:2, carb:75, fat:0, portion:100, cat:'atistirmalik' },
  
  { name:'√áay (≈üekersiz)', emoji:'üçµ', cal:1, prot:0, carb:0, fat:0, portion:200, cat:'icecek' },
  { name:'√áay (≈üekerli)', emoji:'üçµ', cal:30, prot:0, carb:8, fat:0, portion:200, cat:'icecek' },
  { name:'T√ºrk Kahvesi', emoji:'‚òï', cal:12, prot:0, carb:2, fat:0, portion:70, cat:'icecek' },
  { name:'Ayran', emoji:'ü•õ', cal:36, prot:2, carb:3, fat:2, portion:200, cat:'icecek' },
  { name:'Portakal Suyu', emoji:'üßÉ', cal:45, prot:1, carb:10, fat:0, portion:200, cat:'icecek' },
  { name:'S√ºt (tam yaƒülƒ±)', emoji:'ü•õ', cal:60, prot:3, carb:5, fat:3, portion:200, cat:'icecek' },
  { name:'Kola', emoji:'ü•§', cal:42, prot:0, carb:11, fat:0, portion:100, cat:'icecek' },
  { name:'Limonata', emoji:'üçã', cal:40, prot:0, carb:10, fat:0, portion:200, cat:'icecek' },
];

// ============ MEAL DEFINITIONS ============
const MEAL_DEFS = [
  { id:'kahvalti', name:'Kahvaltƒ±', icon:'üåÖ', color:'var(--orange)', colorLight:'var(--orange-light)' },
  { id:'ogle', name:'√ñƒüle Yemeƒüi', icon:'‚òÄÔ∏è', color:'var(--green)', colorLight:'var(--green-light)' },
  { id:'aksam', name:'Ak≈üam Yemeƒüi', icon:'üåô', color:'var(--blue)', colorLight:'var(--blue-light)' },
  { id:'atistirmalik', name:'Atƒ±≈ütƒ±rmalƒ±k', icon:'üçø', color:'var(--purple)', colorLight:'var(--purple-light)' },
];

// ============ STATE ============
let dailyTarget = 2200;
let protTarget = 130;
let carbTarget = 275;
let fatTarget = 73;
let currentMealId = null;
let selectedCat = 'all';
let currentDate = new Date();
let pendingFood = null;
let deferredPrompt = null;

// ============ DATE HELPERS ============
function dateKey(d) {
  const dd = d || currentDate;
  return `${dd.getFullYear()}-${String(dd.getMonth()+1).padStart(2,'0')}-${String(dd.getDate()).padStart(2,'0')}`;
}

function isToday(d) {
  const t = new Date();
  return d.getFullYear() === t.getFullYear() && d.getMonth() === t.getMonth() && d.getDate() === t.getDate();
}

function formatDateShort(d) {
  const days = ['Paz','Pzt','Sal','√áar','Per','Cum','Cmt'];
  const months = ['Oca','≈ûub','Mar','Nis','May','Haz','Tem','Aƒüu','Eyl','Eki','Kas','Ara'];
  if (isToday(d)) return 'Bug√ºn';
  return `${d.getDate()} ${months[d.getMonth()]}, ${days[d.getDay()]}`;
}

function setHeaderDate() {
  const days = ['Pazar','Pazartesi','Salƒ±','√áar≈üamba','Per≈üembe','Cuma','Cumartesi'];
  const months = ['Ocak','≈ûubat','Mart','Nisan','Mayƒ±s','Haziran','Temmuz','Aƒüustos','Eyl√ºl','Ekim','Kasƒ±m','Aralƒ±k'];
  const d = new Date();
  document.getElementById('todayDate').textContent = `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]}`;
}

function updateDateNav() {
  document.getElementById('navDate').textContent = formatDateShort(currentDate);
  const btn = document.getElementById('todayBtn');
  btn.classList.toggle('show', !isToday(currentDate));
}

function changeDate(delta) {
  currentDate.setDate(currentDate.getDate() + delta);
  updateDateNav();
  renderMeals();
  updateHeader();
}

function goToday() {
  currentDate = new Date();
  updateDateNav();
  renderMeals();
  updateHeader();
}

// ============ STORAGE ============
function getDayData(dk) {
  const key = dk || dateKey();
  const raw = localStorage.getItem('cm_day_' + key);
  if (raw) return JSON.parse(raw);
  return { kahvalti:[], ogle:[], aksam:[], atistirmalik:[] };
}

function saveDayData(dk, data) {
  localStorage.setItem('cm_day_' + (dk || dateKey()), JSON.stringify(data));
}

function saveProfile() {
  const profile = {
    gender: document.getElementById('pGender').value,
    age: document.getElementById('pAge').value,
    height: document.getElementById('pHeight').value,
    weight: document.getElementById('pWeight').value,
    activity: document.getElementById('pActivity').value,
    goal: document.getElementById('pGoal').value,
    dailyTarget,
    protTarget,
    carbTarget,
    fatTarget,
  };
  localStorage.setItem('cm_profile', JSON.stringify(profile));
}

function loadProfile() {
  const raw = localStorage.getItem('cm_profile');
  if (!raw) return;
  const p = JSON.parse(raw);
  document.getElementById('pGender').value = p.gender || 'male';
  document.getElementById('pAge').value = p.age || 25;
  document.getElementById('pHeight').value = p.height || 175;
  document.getElementById('pWeight').value = p.weight || 75;
  document.getElementById('pActivity').value = p.activity || '1.375';
  document.getElementById('pGoal').value = p.goal || '0';
  if (p.dailyTarget) dailyTarget = p.dailyTarget;
  if (p.protTarget) protTarget = p.protTarget;
  if (p.carbTarget) carbTarget = p.carbTarget;
  if (p.fatTarget) fatTarget = p.fatTarget;
}

// ============ CALCULATIONS ============
function getTotals() {
  const data = getDayData();
  let cal=0, prot=0, carb=0, fat=0;
  Object.values(data).forEach(foods => foods.forEach(f => {
    cal += f.cal; prot += f.prot; carb += f.carb; fat += f.fat;
  }));
  return { cal:Math.round(cal), prot, carb, fat };
}

function getMealCal(mealId) {
  const data = getDayData();
  return Math.round((data[mealId] || []).reduce((s,f) => s + f.cal, 0));
}

function updateHeader() {
  const t = getTotals();
  const remain = Math.max(0, dailyTarget - t.cal);
  document.getElementById('calRemain').textContent = remain;

  const pct = Math.min(1, t.cal / dailyTarget);
  const circumference = 2 * Math.PI * 44;
  document.getElementById('calRing').style.strokeDashoffset = circumference * (1 - pct);

  if (t.cal > dailyTarget) {
    document.getElementById('calRing').style.stroke = '#ff7070';
  } else {
    document.getElementById('calRing').style.stroke = 'white';
  }

  const protPct = Math.min(100, (t.prot / protTarget) * 100);
  const carbPct = Math.min(100, (t.carb / carbTarget) * 100);
  const fatPct = Math.min(100, (t.fat / fatTarget) * 100);

  document.getElementById('protBar').style.width = protPct + '%';
  document.getElementById('carbBar').style.width = carbPct + '%';
  document.getElementById('fatBar').style.width = fatPct + '%';
  document.getElementById('protVal').textContent = Math.round(t.prot) + 'g';
  document.getElementById('carbVal').textContent = Math.round(t.carb) + 'g';
  document.getElementById('fatVal').textContent = Math.round(t.fat) + 'g';
}

// ============ RENDER MEALS ============
function renderMeals() {
  const container = document.getElementById('mealsContainer');
  const data = getDayData();
  
  let html = '';
  MEAL_DEFS.forEach(meal => {
    const foods = data[meal.id] || [];
    const mealCal = Math.round(foods.reduce((s,f) => s + f.cal, 0));

    let foodsHTML = '';
    if (foods.length === 0) {
      foodsHTML = '<div class="empty-meal">Hen√ºz yemek eklenmedi</div>';
    } else {
      foods.forEach((f, fi) => {
        foodsHTML += `
          <div class="food-item">
            <div class="food-emoji">${f.emoji || 'üçΩÔ∏è'}</div>
            <div class="food-info">
              <div class="food-name">${f.name}</div>
              <div class="food-macros">
                <span>P:${Math.round(f.prot)}g</span>
                <span>K:${Math.round(f.carb)}g</span>
                <span>Y:${Math.round(f.fat)}g</span>
                <span>‚Ä¢ ${Math.round(f.portionUsed || f.portion)}g</span>
              </div>
            </div>
            <div class="food-cal">${Math.round(f.cal)}</div>
            <button class="food-delete" onclick="removeFood('${meal.id}',${fi})">‚úï</button>
          </div>`;
      });
    }

    html += `
      <div class="meal-section">
        <div class="meal-header">
          <div class="meal-title">
            <div class="meal-icon" style="background:${meal.colorLight}">${meal.icon}</div>
            ${meal.name}
          </div>
          <div class="meal-kcal">${mealCal} kcal</div>
        </div>
        <div class="meal-card">
          ${foodsHTML}
          <div class="add-food-btn" onclick="openAddFood('${meal.id}')">Ôºã Yemek Ekle</div>
        </div>
      </div>`;
  });

  // Keep install banner
  const banner = document.getElementById('installBanner');
  container.innerHTML = html;
  if (banner && banner.classList.contains('show')) {
    container.insertBefore(banner, container.firstChild);
  }
}

// ============ FOOD MODAL ============
function openAddFood(mealId) {
  currentMealId = mealId;
  const meal = MEAL_DEFS.find(m => m.id === mealId);
  document.getElementById('modalTitle').textContent = `${meal.icon} ${meal.name} ‚Äî Yemek Ekle`;
  document.getElementById('foodSearch').value = '';
  document.getElementById('customName').value = '';
  document.getElementById('customCal').value = '';
  document.getElementById('customProt').value = '';
  document.getElementById('customCarb').value = '';
  document.getElementById('customFat').value = '';
  document.getElementById('customPortion').value = '100';
  selectedCat = 'all';
  document.querySelectorAll('.cat-pill').forEach((p,i) => p.classList.toggle('active', i===0));
  renderFoodDb();
  document.getElementById('addFoodModal').classList.add('show');
  setTimeout(() => document.getElementById('foodSearch').focus(), 300);
}

function closeModal() {
  document.getElementById('addFoodModal').classList.remove('show');
}

function filterCat(cat) {
  selectedCat = cat;
  document.querySelectorAll('.cat-pill').forEach(p => {
    p.classList.toggle('active', p.textContent.includes(
      cat === 'all' ? 'T√ºm√º' : cat === 'kahvalti' ? 'Kahvaltƒ±' : cat === 'ana' ? 'Ana' : cat === 'atistirmalik' ? 'Atƒ±≈ütƒ±rmalƒ±k' : 'ƒ∞√ßecek'
    ));
  });
  renderFoodDb();
}

function renderFoodDb() {
  const q = (document.getElementById('foodSearch').value || '').toLowerCase().trim();
  let filtered = FOOD_DB;
  if (selectedCat !== 'all') filtered = filtered.filter(f => f.cat === selectedCat);
  if (q) filtered = filtered.filter(f => f.name.toLowerCase().includes(q));

  const list = document.getElementById('foodDbList');
  list.innerHTML = filtered.slice(0, 20).map(f => `
    <div class="food-db-item" onclick="selectDbFood('${f.name}')">
      <span class="fdb-emoji">${f.emoji}</span>
      <div class="fdb-info">
        <div class="fdb-name">${f.name}</div>
        <div class="fdb-detail">P:${f.prot}g K:${f.carb}g Y:${f.fat}g ‚Ä¢ 100g ba≈üƒ±na</div>
      </div>
      <div class="fdb-cal">${f.cal} kcal</div>
    </div>
  `).join('');

  if (filtered.length === 0) {
    list.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text2);font-size:0.82rem">Sonu√ß bulunamadƒ± üòï</div>';
  }
}

function filterFoods() { renderFoodDb(); }

// ============ PORTION MODAL ============
function selectDbFood(name) {
  pendingFood = FOOD_DB.find(f => f.name === name);
  if (!pendingFood) return;
  
  closeModal();
  
  document.getElementById('portionEmoji').textContent = pendingFood.emoji;
  document.getElementById('portionFoodName').textContent = pendingFood.name;
  document.getElementById('portionFoodBase').textContent = `100g ba≈üƒ±na: ${pendingFood.cal} kcal`;
  document.getElementById('portionInput').value = pendingFood.portion || 100;
  updatePortionPreview();
  
  document.getElementById('portionModal').classList.add('show');
}

function updatePortionPreview() {
  if (!pendingFood) return;
  const g = parseFloat(document.getElementById('portionInput').value) || 0;
  const ratio = g / 100;
  
  document.getElementById('portionPreview').innerHTML = `
    <span><div class="pv-val">${Math.round(pendingFood.cal * ratio)}</div>kcal</span>
    <span><div class="pv-val">${Math.round(pendingFood.prot * ratio)}g</div>Protein</span>
    <span><div class="pv-val">${Math.round(pendingFood.carb * ratio)}g</div>Karb</span>
    <span><div class="pv-val">${Math.round(pendingFood.fat * ratio)}g</div>Yaƒü</span>
  `;
}

function confirmPortion() {
  if (!pendingFood || !currentMealId) return;
  const g = parseFloat(document.getElementById('portionInput').value) || 100;
  const ratio = g / 100;
  
  const food = {
    name: pendingFood.name,
    emoji: pendingFood.emoji,
    cal: pendingFood.cal * ratio,
    prot: pendingFood.prot * ratio,
    carb: pendingFood.carb * ratio,
    fat: pendingFood.fat * ratio,
    portionUsed: g,
    portion: g,
  };
  
  const data = getDayData();
  data[currentMealId].push(food);
  saveDayData(null, data);
  
  closePortionModal();
  renderMeals();
  updateHeader();
  showToast(`‚úÖ ${food.name} (${Math.round(g)}g) eklendi!`);
}

function closePortionModal() {
  document.getElementById('portionModal').classList.remove('show');
  pendingFood = null;
}

// ============ CUSTOM FOOD ============
function addCustomFood() {
  const name = document.getElementById('customName').value.trim();
  const cal = parseFloat(document.getElementById('customCal').value) || 0;
  const prot = parseFloat(document.getElementById('customProt').value) || 0;
  const carb = parseFloat(document.getElementById('customCarb').value) || 0;
  const fat = parseFloat(document.getElementById('customFat').value) || 0;
  const portion = parseFloat(document.getElementById('customPortion').value) || 100;

  if (!name) { showToast('‚ö†Ô∏è Yemek adƒ± girin'); return; }
  if (cal === 0) { showToast('‚ö†Ô∏è Kalori deƒüeri girin'); return; }

  const data = getDayData();
  data[currentMealId].push({ name, emoji:'üçΩÔ∏è', cal, prot, carb, fat, portion, portionUsed:portion });
  saveDayData(null, data);

  closeModal();
  renderMeals();
  updateHeader();
  showToast(`‚úÖ ${name} eklendi!`);
}

function removeFood(mealId, idx) {
  const data = getDayData();
  const removed = data[mealId].splice(idx, 1)[0];
  saveDayData(null, data);
  renderMeals();
  updateHeader();
  showToast(`üóëÔ∏è ${removed.name} silindi`);
}

// ============ STATS ============
function renderStats() {
  const t = getTotals();
  const container = document.getElementById('statsContainer');
  
  // Get last 7 days data
  const days = ['Paz','Pzt','Sal','√áar','Per','Cum','Cmt'];
  const weekDays = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    const dk = dateKey(d);
    const dayData = getDayData(dk);
    let dayCal = 0;
    Object.values(dayData).forEach(foods => foods.forEach(f => dayCal += f.cal));
    weekDays.push({ day: days[d.getDay()], cal: Math.round(dayCal), isToday: i === 0 });
  }

  const maxCal = Math.max(dailyTarget, ...weekDays.map(d => d.cal), 100);

  container.innerHTML = `
    <div class="stat-card">
      <h3>üìä Son 7 G√ºn</h3>
      <div class="target-line"><span>Hedef: ${dailyTarget} kcal</span></div>
      <div class="week-chart">
        ${weekDays.map(d => {
          const h = d.cal > 0 ? Math.max(6, (d.cal / maxCal) * 100) : 3;
          const cls = d.isToday ? 'today' : d.cal === 0 ? 'empty' : d.cal > dailyTarget ? 'over' : 'under';
          return `
            <div class="week-bar">
              <div class="cal-label">${d.cal > 0 ? d.cal : '‚Äî'}</div>
              <div class="bar ${cls}" style="height:${h}%"></div>
              <div class="day-label">${d.day}</div>
            </div>`;
        }).join('')}
      </div>
    </div>

    <div class="stat-card" style="animation-delay:0.05s">
      <h3>ü•ó Bug√ºnk√º Makrolar</h3>
      <div class="macro-detail-grid">
        <div class="macro-detail-item" style="background:var(--red-light)">
          <div class="macro-circle" style="background:#ff7a7a;color:white">${Math.round(t.prot)}g</div>
          <div class="md-name">Protein</div>
          <div class="md-val">${protTarget}g hedef</div>
        </div>
        <div class="macro-detail-item" style="background:var(--orange-light)">
          <div class="macro-circle" style="background:#ffcc55;color:#7a5500">${Math.round(t.carb)}g</div>
          <div class="md-name">Karbonhidrat</div>
          <div class="md-val">${carbTarget}g hedef</div>
        </div>
        <div class="macro-detail-item" style="background:var(--blue-light)">
          <div class="macro-circle" style="background:#77bbff;color:white">${Math.round(t.fat)}g</div>
          <div class="md-name">Yaƒü</div>
          <div class="md-val">${fatTarget}g hedef</div>
        </div>
      </div>
    </div>

    <div class="stat-card" style="animation-delay:0.1s">
      <h3>üéØ G√ºnl√ºk √ñzet</h3>
      <div style="display:flex;justify-content:space-between;padding:8px 0">
        <span style="color:var(--text2);font-size:0.82rem">Toplam</span>
        <span style="font-weight:700">${t.cal} kcal</span>
      </div>
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-top:1px solid #f5f2ed">
        <span style="color:var(--text2);font-size:0.82rem">Hedef</span>
        <span style="font-weight:700">${dailyTarget} kcal</span>
      </div>
      <div style="display:flex;justify-content:space-between;padding:8px 0;border-top:1px solid #f5f2ed">
        <span style="color:var(--text2);font-size:0.82rem">Kalan</span>
        <span style="font-weight:700;color:${t.cal > dailyTarget ? 'var(--red)' : 'var(--green)'}">${dailyTarget - t.cal} kcal</span>
      </div>
    </div>
  `;
}

// ============ PROFILE / TDEE ============
function calculateTDEE() {
  const gender = document.getElementById('pGender').value;
  const age = parseInt(document.getElementById('pAge').value);
  const height = parseInt(document.getElementById('pHeight').value);
  const weight = parseInt(document.getElementById('pWeight').value);
  const activity = parseFloat(document.getElementById('pActivity').value);
  const goal = parseInt(document.getElementById('pGoal').value);

  let bmr;
  if (gender === 'male') {
    bmr = 10 * weight + 6.25 * height - 5 * age + 5;
  } else {
    bmr = 10 * weight + 6.25 * height - 5 * age - 161;
  }

  const tdee = Math.round(bmr * activity + goal);
  dailyTarget = tdee;
  protTarget = Math.round((tdee * 0.30) / 4);
  carbTarget = Math.round((tdee * 0.45) / 4);
  fatTarget = Math.round((tdee * 0.25) / 9);

  document.getElementById('tdeeNum').textContent = tdee;
  document.getElementById('calResult').classList.add('show');

  saveProfile();
  updateHeader();
  showToast(`üéØ G√ºnl√ºk hedef: ${tdee} kcal`);
}

function resetAllData() {
  if (confirm('T√ºm verileriniz silinecek. Emin misiniz?')) {
    const keys = Object.keys(localStorage).filter(k => k.startsWith('cm_'));
    keys.forEach(k => localStorage.removeItem(k));
    dailyTarget = 2200; protTarget = 130; carbTarget = 275; fatTarget = 73;
    location.reload();
  }
}

// ============ TABS ============
function switchTab(tab) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + tab).classList.add('active');
  document.getElementById('nav-' + tab).classList.add('active');
  if (tab === 'istatistik') renderStats();
}

// ============ TOAST ============
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._timer);
  t._timer = setTimeout(() => t.classList.remove('show'), 2000);
}

// ============ MODAL OVERLAYS ============
document.getElementById('addFoodModal').addEventListener('click', e => {
  if (e.target.id === 'addFoodModal') closeModal();
});
document.getElementById('portionModal').addEventListener('click', e => {
  if (e.target.id === 'portionModal') closePortionModal();
});

// ============ PWA INSTALL ============
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installBanner').classList.add('show');
});

function installPWA() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(r => {
      if (r.outcome === 'accepted') showToast('üéâ Uygulama kuruldu!');
      deferredPrompt = null;
      document.getElementById('installBanner').classList.remove('show');
    });
  }
}

function dismissInstall() {
  document.getElementById('installBanner').classList.remove('show');
}

// ============ REGISTER SERVICE WORKER & MANIFEST ============
function setupPWA() {
  // Create manifest blob
  const manifest = {
    name: "CalorieMate - Beslenme Takibi",
    short_name: "CalorieMate",
    description: "G√ºnl√ºk kalori ve beslenme takip uygulamasƒ±",
    start_url: location.href,
    display: "standalone",
    background_color: "#faf8f4",
    theme_color: "#e85d3a",
    orientation: "portrait",
    icons: [
      {
        src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect fill='%23e85d3a' width='512' height='512' rx='100'/><text x='256' y='340' text-anchor='middle' font-size='280'>üçΩ</text></svg>",
        sizes: "512x512",
        type: "image/svg+xml",
        purpose: "any maskable"
      }
    ]
  };
  
  const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
  document.getElementById('manifestLink').href = URL.createObjectURL(blob);

  // Register service worker
  if ('serviceWorker' in navigator) {
    const swCode = `
      const CACHE_NAME = 'caloriemate-v1';
      const urlsToCache = [self.location.href];
      
      self.addEventListener('install', e => {
        e.waitUntil(
          caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
        );
        self.skipWaiting();
      });
      
      self.addEventListener('activate', e => {
        e.waitUntil(
          caches.keys().then(names => 
            Promise.all(names.filter(n => n !== CACHE_NAME).map(n => caches.delete(n)))
          )
        );
        self.clients.claim();
      });
      
      self.addEventListener('fetch', e => {
        e.respondWith(
          caches.match(e.request).then(r => r || fetch(e.request).catch(() => caches.match(self.location.href)))
        );
      });
    `;
    
    const swBlob = new Blob([swCode], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(swBlob);
    
    navigator.serviceWorker.register(swUrl).then(reg => {
      console.log('SW registered');
    }).catch(err => {
      console.log('SW registration skipped (expected in some contexts):', err.message);
    });
  }
}

// ============ INIT ============
setHeaderDate();
loadProfile();
updateDateNav();
renderMeals();
updateHeader();
setupPWA();
</script>

</body>
</html>
